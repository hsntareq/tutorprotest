<?php
/**
 * Earnings template
 * 
 * @since 1.9.9
 */
use TUTOR_REPORT\Analytics;
//global variables
$user         = wp_get_current_user();
$time_period  = $active = isset( $_GET['period'] ) ? $_GET['period'] : '';
$start_date   = isset( $_GET['start_date']) ? sanitize_text_field( $_GET['start_date'] ) : '';
$end_date     = isset( $_GET['end_date']) ? sanitize_text_field( $_GET['end_date'] ) : '';
if ( '' !== $start_date ) {
    $start_date = tutor_get_formated_date( 'Y-m-d', $start_date);
} 
if ( '' !== $end_date ) {
    $end_date = tutor_get_formated_date( 'Y-m-d', $end_date);
} 
?>
<div class="tutor-analytics-earnings">
        
    <!--analytics graph -->
    <?php
        /**
         * Earnings card info
         * 
         * @since 1.9.9
         */
        $card_template  = TUTOR_REPORT()->path.'templates/elements/box-card.php';
        $user           = wp_get_current_user();
        $earnings       = tutor_utils()->get_earning_sum( $user->ID );

        $data  = array(
            array(
                'icon'      => '<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44"><path d="M31.94 14.187a1.518 1.518 0 0 1 1.484 1.485v4.098H24.374a.826.826 0 0 1-.16 0c-.29.032-.572.115-.834.245a2.38 2.38 0 0 0-.678.508c-.227.229-.408.499-.534.796-.131.309-.199.642-.198.978v3.338a2.468 2.468 0 0 0 .748 1.849 2.42 2.42 0 0 0 1.811.759h8.895v4.172a1.426 1.426 0 0 1-.443 1.069 1.469 1.469 0 0 1-1.069.432H9.736a1.436 1.436 0 0 1-1.042-.432 1.427 1.427 0 0 1-.444-1.069V15.48c.01-.066.024-.132.043-.197.032-.086.075-.177.118-.273.043-.098.098-.19.165-.272.151-.165.333-.3.535-.396.205-.103.432-.156.662-.154h22.166Zm-17.455-1.042h-1.458l9.547-4.723a1.378 1.378 0 0 1 1.132-.09 1.463 1.463 0 0 1 .877.768l.571 1.122-10.669 2.923Zm13.955-2.848c.328 0 .646.111.903.315.264.206.46.488.56.807l.47 1.726H17.905l10.151-2.794.198-.038c.061-.01.124-.016.187-.016Zm6.026 10.91c.157.135.282.303.369.491.086.197.13.41.128.625v3.34a1.454 1.454 0 0 1-.497 1.1 1.31 1.31 0 0 1-.518.31.594.594 0 0 1-.235.064h-9.184a1.47 1.47 0 0 1-1.069-.433 1.395 1.395 0 0 1-.443-1.069v-3.312a1.512 1.512 0 0 1 1.512-1.512h8.949c.078-.006.157-.006.235 0l.235.054c.098.033.193.076.283.128.087.062.166.133.235.214Zm-6.806 3.072v-.497a.764.764 0 0 0-.759-.759h-.486a.658.658 0 0 0-.246.053c-.076.037-.15.08-.219.129a.57.57 0 0 0-.213.235.815.815 0 0 0-.075.342v.497a.746.746 0 0 0 .753.758h.497a.759.759 0 0 0 .748-.758Z" fill="#3E64DE"/></svg>',
                'title'     => $earnings->instructor_amount,
                'sub_title' => __( 'Total Earning', 'tutor-pro' ),
                'price'     => true
            ),
            array(
                'icon'      => '<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44"><path d="M36.655 23.833H23.06l9.054 9.054c.347.346.916.374 1.272.04a13.72 13.72 0 0 0 4.19-8.071c.076-.542-.373-1.023-.92-1.023Zm-.907-3.712c-.472-6.844-5.94-12.314-12.785-12.786-.522-.036-.962.405-.962.928v12.82h12.82c.524 0 .964-.44.928-.962Zm-16.497 3.712V10.238c0-.547-.481-.997-1.023-.92-6.827.965-12.046 6.93-11.803 14.078.25 7.341 6.571 13.362 13.916 13.27a13.644 13.644 0 0 0 7.75-2.523c.452-.32.482-.987.09-1.38l-8.93-8.93Z" fill="#3E64DE"/></svg>',
                'title'     => $earnings->balance,
                'sub_title' => __( 'Current Balance', 'tutor-pro' ),
                'price'     => true
            ),
            array(
                'icon'      => '<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44"><path d="M7.333 30.554V33c0 2.022 4.927 3.667 11 3.667s11-1.645 11-3.667v-2.446C26.967 32.22 22.641 33 18.333 33s-8.634-.78-11-2.446Zm18.333-15.887c6.073 0 11-1.645 11-3.667s-4.927-3.667-11-3.667-11 1.645-11 3.667 4.927 3.667 11 3.667ZM7.333 24.544V27.5c0 2.022 4.927 3.667 11 3.667s11-1.645 11-3.667v-2.956c-2.366 1.948-6.697 2.956-11 2.956s-8.634-1.008-11-2.956Zm23.833.63c3.283-.636 5.5-1.816 5.5-3.174v-2.446c-1.329.94-3.282 1.58-5.5 1.976v3.644ZM18.333 16.5c-6.073 0-11 2.051-11 4.583 0 2.533 4.927 4.584 11 4.584s11-2.052 11-4.584c0-2.532-4.927-4.583-11-4.583Zm12.564 3.225c3.438-.618 5.77-1.833 5.77-3.225v-2.446c-2.035 1.438-5.53 2.211-9.207 2.394 1.69.82 2.933 1.92 3.437 3.277Z" fill="#3E64DE"/></svg>',
                'title'     => $earnings->withdraws_amount,
                'sub_title' => __( 'Total Withdraws', 'tutor-pro' ),
                'price'     => true
            ),
            array(
                'icon'      => '<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44"><path d="M22 31.167c6.582 0 11.916-5.334 11.916-11.917S28.583 7.333 22 7.333 10.083 12.667 10.083 19.25 15.417 31.167 22 31.167Zm-1.272-18.253v-.963c0-.527.424-.951.95-.951h.637c.527 0 .95.424.95.951v.974c.889.046 1.748.35 2.464.882.321.235.356.705.07.98l-.935.888c-.218.212-.544.218-.802.057a1.886 1.886 0 0 0-1.02-.292h-2.228c-.516 0-.934.47-.934 1.048 0 .47.286.889.693 1.009l3.57 1.071c1.472.441 2.503 1.856 2.503 3.443 0 1.948-1.512 3.524-3.386 3.575v.963a.949.949 0 0 1-.951.95h-.636a.949.949 0 0 1-.95-.95v-.974a4.517 4.517 0 0 1-2.464-.882.642.642 0 0 1-.07-.98l.935-.888c.217-.212.544-.218.802-.057.31.194.653.292 1.02.292h2.228c.516 0 .934-.47.934-1.049 0-.47-.287-.888-.693-1.008l-3.57-1.071c-1.472-.441-2.503-1.857-2.503-3.444.006-1.947 1.512-3.523 3.386-3.574ZM34.833 27.5h-1.862a13.886 13.886 0 0 1-4.182 3.667h3.655c.304 0 .55.206.55.458v.917c0 .252-.246.458-.55.458H11.55c-.304 0-.55-.206-.55-.458v-.917c0-.252.246-.458.55-.458h3.655a13.954 13.954 0 0 1-4.182-3.667H9.166c-1.014 0-1.833.82-1.833 1.833v5.5c0 1.014.82 1.834 1.833 1.834h25.667c1.014 0 1.833-.82 1.833-1.834v-5.5c0-1.014-.819-1.833-1.833-1.833Z" fill="#3E64DE"/></svg>',
                'title'     => $earnings->course_price_total,
                'sub_title' => __( 'Total Sale', 'tutor-pro' ),
                'price'     => true
            ),
            array(
                'icon'      => '<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44"><path d="m27.526 17.248 4.928-5.448c.971-.972.283-2.633-1.091-2.633h-23.4c-1.375 0-2.063 1.661-1.091 2.633l8.895 9.833v7.593c0 .614.289 1.19.78 1.559l3.894 2.922c1.016.761 2.36.339 2.884-.661a9.318 9.318 0 0 1-2.883-6.738c0-4.372 3.022-8.043 7.084-9.06Zm2.266 1.269A7.791 7.791 0 0 0 22 26.308a7.791 7.791 0 0 0 7.792 7.792 7.791 7.791 0 0 0 7.792-7.792 7.791 7.791 0 0 0-7.792-7.791Zm.78 11.681v.785a.39.39 0 0 1-.39.39h-.78a.39.39 0 0 1-.39-.39v-.793a2.788 2.788 0 0 1-1.527-.553.39.39 0 0 1-.028-.59l.572-.547a.4.4 0 0 1 .494-.035c.188.118.402.18.624.18h1.37c.316 0 .574-.287.574-.641 0-.29-.176-.545-.427-.62l-2.192-.658c-.905-.271-1.538-1.14-1.538-2.113 0-1.194.928-2.164 2.078-2.195v-.785a.39.39 0 0 1 .39-.39h.779a.39.39 0 0 1 .39.39v.794c.55.028 1.084.22 1.527.552.19.143.2.428.028.592l-.572.545a.4.4 0 0 1-.493.036 1.168 1.168 0 0 0-.625-.181h-1.369c-.316 0-.574.288-.574.642 0 .29.176.545.427.62l2.191.658c.905.271 1.538 1.14 1.538 2.113 0 1.194-.927 2.164-2.078 2.194Z" fill="#3E64DE"/></svg>',
                'title'     => $earnings->admin_amount,
                'sub_title' => __( 'Deducted Commissions', 'tutor-pro' ),
                'price'     => true
            ),
            array(
                'icon'      => '<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44"><path d="M35.75 23.63a1.8 1.8 0 0 1 .352 1.538 1.761 1.761 0 0 1-.956 1.244l-.663.37c-.343.194-.617.488-.786.844a1.818 1.818 0 0 0-.159 1.173l.147.745a1.934 1.934 0 0 1-1.76 2.265h-.745a1.813 1.813 0 0 0-1.103.416 1.943 1.943 0 0 0-.646.986l-.17.715a1.853 1.853 0 0 1-1.003 1.22 1.796 1.796 0 0 1-1.578.042l-.757-.282a1.76 1.76 0 0 0-1.144-.082c-.387.085-.739.29-1.003.587l-.487.586a1.814 1.814 0 0 1-1.431.67 1.86 1.86 0 0 1-1.432-.629l-.516-.586a1.795 1.795 0 0 0-1.003-.587 1.842 1.842 0 0 0-1.173.13l-.687.287a1.896 1.896 0 0 1-2.581-1.232l-.229-.716a1.66 1.66 0 0 0-.627-.974 1.918 1.918 0 0 0-1.121-.387l-.745-.03a1.813 1.813 0 0 1-1.402-.698 1.84 1.84 0 0 1-.4-1.537l.112-.739c.08-.398.025-.81-.158-1.173a1.807 1.807 0 0 0-.815-.845l-.657-.346a1.76 1.76 0 0 1-.963-1.238 1.854 1.854 0 0 1 .305-1.537l.429-.627c.232-.32.35-.709.334-1.103a2.118 2.118 0 0 0-.358-1.133l-.457-.586A1.86 1.86 0 0 1 8.34 17.6l.657-.37c.346-.192.622-.488.792-.844.178-.364.232-.776.153-1.174l-.14-.745a1.877 1.877 0 0 1 .386-1.53 1.85 1.85 0 0 1 1.414-.734l.745-.03a1.836 1.836 0 0 0 1.085-.416 1.76 1.76 0 0 0 .634-.986l.2-.715a1.854 1.854 0 0 1 1.003-1.22 1.76 1.76 0 0 1 1.572-.042l.692.258c.367.171.781.21 1.174.112.387-.085.739-.29 1.003-.587l.487-.586a1.813 1.813 0 0 1 1.431-.657 1.866 1.866 0 0 1 1.431.627l.517.587c.258.303.612.51 1.003.587a1.96 1.96 0 0 0 1.173-.1l.687-.317a1.895 1.895 0 0 1 2.58 1.232l.23.716c.085.39.308.735.627.974a1.9 1.9 0 0 0 1.115.404l.745.03a1.907 1.907 0 0 1 1.432.704 1.836 1.836 0 0 1 .398 1.52l-.111.738a1.76 1.76 0 0 0 .152 1.174c.173.365.462.662.822.844l.657.347a1.843 1.843 0 0 1 .956 1.26 1.907 1.907 0 0 1-.3 1.544l-.427.586a1.695 1.695 0 0 0-.388 1.11c.007.403.131.797.358 1.131l.464.599Zm-10.484 3.24a3.38 3.38 0 0 0 .775-3.052 3.813 3.813 0 0 0-1.948-2.593 8.867 8.867 0 0 0-1.003-.498l-1.068-.446a5.582 5.582 0 0 1-.586-.27 4.779 4.779 0 0 1-.54-.358.967.967 0 0 1 .229-1.76c.111-.04.228-.07.34-.1a1.4 1.4 0 0 1 .346-.046c.45-.017.9.016 1.343.1.436.087.86.226 1.262.416.136.085.3.117.457.088.1-.041.182-.164.258-.375.077-.212.124-.458.188-.687.065-.229.14-.458.217-.686a.534.534 0 0 0-.03-.388.54.54 0 0 0-.287-.24 8.557 8.557 0 0 0-.815-.305 8.097 8.097 0 0 0-.845-.211 1.537 1.537 0 0 1-.645-.188 1.273 1.273 0 0 1-.1-.675 1.818 1.818 0 0 0-.129-.927 1.795 1.795 0 0 0-.933-.129h-.457a.868.868 0 0 0-.487.13c-.076.064-.112.222-.112.469v.686c.025.2-.006.403-.088.587a1.655 1.655 0 0 1-.545.275 4.393 4.393 0 0 0-1.83 1.232 3.402 3.402 0 0 0-.775 2.06c-.06.666.105 1.333.47 1.895.383.536.877.984 1.448 1.314.37.236.763.432 1.174.586.41.153.815.317 1.214.487.152.076.3.159.446.24.146.083.281.177.416.276a1.226 1.226 0 0 1 .493 1.156 1.208 1.208 0 0 1-.774.956 3.565 3.565 0 0 1-.763.2c-.25.04-.506.04-.757 0a8.402 8.402 0 0 1-1.202-.24 5.332 5.332 0 0 1-1.115-.447c-.229-.111-.387-.152-.475-.111-.088.041-.17.17-.247.399-.076.229-.111.416-.17.587-.058.17-.111.404-.17.616a.927.927 0 0 0-.047.557c.121.162.286.286.476.358.327.153.666.278 1.014.375.358.094.716.17 1.08.229a.856.856 0 0 1 .487.158c.073.166.102.348.082.528v.804c.01.144.06.283.146.399a.452.452 0 0 0 .37.14h1.173a.47.47 0 0 0 .376-.128.552.552 0 0 0 .111-.382v-.545a4.103 4.103 0 0 0 0-.546.668.668 0 0 1 .118-.428.74.74 0 0 1 .399-.229 4.206 4.206 0 0 0 1.138-.498c.338-.225.641-.5.897-.816Z" fill="#3E64DE"/></svg>',
                'title'     => $earnings->deduct_fees_amount,
                'sub_title' => __( 'Deducted Fees', 'tutor-pro' ),
                'price'     => true
            )
        );
       
        tutor_load_template_from_custom_path($card_template, $data);
    ?>

    <!--card info end -->

    <!--filter buttons tabs-->
    <?php 
        /**
         * Prepare filter period buttons
         * 
         * Array structure is required as below
         * 
         * @since 1.9.8
         */
        $filter_period = array(
            array(
                'url'   => esc_url( tutor_utils()->tutor_dashboard_url().'analytics/earnings?period=today' ),
                'title' => __( 'Today', 'tutor-pro' ),
                'class' => 'tutor-analytics-period-button',
                'type'  => 'today'
            ),
            array(
                'url'   => esc_url( tutor_utils()->tutor_dashboard_url().'analytics/earnings?period=monthly' ),
                'title' => __( 'Monthly', 'tutor-pro' ),
                'class' => 'tutor-analytics-period-button',
                'type'  => 'monthly'
            ),
            array(
                'url'   => esc_url( tutor_utils()->tutor_dashboard_url().'analytics/earnings?period=yearly' ),
                'title' => __( 'Yearly', 'tutor-pro' ),
                'class' => 'tutor-analytics-period-button',
                'type'  => 'yearly'
            ),
        );

        /**
         * Calendar date buttons
         * 
         * Array structure is required as below
         * 
         * @since 1.9.8
         */
        
        $filter_period_calendar = array(
            'filter_period'     => $filter_period,
            'filter_calendar'   => true
        );

        $filter_period_calendar_template = TUTOR_REPORT()->path.'templates/elements/period-calendar.php';
        tutor_load_template_from_custom_path($filter_period_calendar_template, $filter_period_calendar);
    ?>

    <!--filter button tabs end-->

    <!--analytics graph -->
    <?php
        /**
         * Get analytics data
         * 
         * @since 1.9.9
         */
        $commission_fees    = Analytics::commission_fees_by_user($user->ID, $time_period, $start_date, $end_date);
        $content_title  = ''; 
        if (  'today' === $time_period ) {
            $day = date('l');
            $content_title = __( "for today ($day) ", 'tutor-pro' );
        } else if ( 'monthly' === $time_period ) {
            $month = date('F');
            $content_title = __( "for this month ($month) ", 'tutor-pro' );
        } else if ( 'yearly' === $time_period ) {
            $year = date('Y');
            $content_title = __( "for this year ($year) ", 'tutor-pro' );
        }
        $graph_tabs = array(
            array(
                'tab_title'     => __( 'Total Earning', 'tutor-pro' ),
                'tab_value'     => Analytics::get_earnings_by_user( $user->ID, $time_period, $start_date, $end_date)['total_earnings'],
                'data_attr'     => 'ta_total_earnings',
                'active'        => 'active',
                'price'         => true,
                'content_title' => __( 'Earning chart '.$content_title, 'tutor-pro' )
            ),
            array(
                'tab_title'     => __( 'Number of Sales', 'tutor-pro' ),
                'tab_value'     => Analytics::number_of_sales($user->ID, $time_period, $start_date, $end_date)['total_sales'],
                'data_attr'     => 'ta_total_course_enrolled',
                'active'        => '',
                'price'         => false,
                'content_title' => __( 'Sales chart '.$content_title, 'tutor-pro' )
            ),
            array(
                'tab_title'     => __( 'Commission & Fees', 'tutor-pro' ),
                'tab_value'     => $commission_fees['total'],
                'data_attr'     => 'ta_total_refund',
                'active'        => '',
                'price'         => true,
                'content_title' => __( 'Commission & fess chart '.$content_title, 'tutor-pro' )
            ),
        );
        $graph_template = TUTOR_REPORT()->path.'templates/elements/graph.php';
        tutor_load_template_from_custom_path($graph_template, $graph_tabs);
    ?>
    <!--analytics graph end -->    
</div>